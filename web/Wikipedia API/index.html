<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikipedia API</title>

    <style>
        body {
            max-width: 800px;
            margin: auto;
        }

        @media screen and (max-width:800px) {
            body {
                margin: 10px
            }
        }

        .displayer {
            height: 200px;
            border: 1px solid black;
            overflow: auto;
        }

        input,
        button {
            font: unset;
            border: solid 1px black;
        }
    </style>
</head>

<body>
    <header>
        <h1>Wikipedia API</h1>
        <p>Knowledge by Demand</p>
    </header>
    <hr>
    <main>

        <h2>Read an article</h2>
        <input id="inputRead" type="text"><button onclick="wikiRead()">Search</button>
        <div id="displayRead" class="displayer"></div>

        <h2>Search by name</h2>
        <input id="inputSearch" type="text"><button onclick="wikiSearch()">Search</button>
        <div id="displaySearch" class="displayer"></div>

        <h2>Search categories</h2>
        <input id="inputCategory" type="text"><button onclick="wikiCategories()">Search</button>
        <div id="displayCategories" class="displayer"></div>

        <h2>Search articles by category</h2>
        <input id="inputCatArt" type="text"><button onclick="wikiCatArt()">Search</button>
        <div id="displayCatArt" class="displayer"></div>

        <h1>Wikimedia API</h1>
        <h2>Search images by category</h2>
        <input id="inputWikimediaImages" type="text"><button onclick="wikimediaImages()">Search</button>
        <div id="displayWikimediaImages" class="displayer"></div>



    </main>
    <hr>
    <footer>
        <p>by dibesfer with wikipedia</p>
    </footer>

    <script>

        async function wikiRead(title) {


            //Only text
            //const url = `https://es.wikipedia.org/w/api.php?action=query&prop=extracts&explaintext=1&titles=${encodeURIComponent(title)}&format=json&origin=*`;

            if (!title) title = inputRead.value

            const url = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts|info|pageimages&inprop=url&piprop=thumbnail&pithumbsize=600&explaintext=1&titles=${encodeURIComponent(title)}&origin=*&exintro=1`;

            /*

            https://en.wikipedia.org/w/api.php
            ?action=query
            &format=json
            &prop=extracts|info|pageimages
            &inprop=url
            &piprop=thumbnail
            &pithumbsize=600
            &explaintext=1
            &titles=${encodeURIComponent(title)}
            &origin=*
            &exintro=1 IT GETS THE FIRST SECTION

            */

            const res = await fetch(url);
            const data = await res.json();
            const page = Object.values(data.query.pages)[0];

            console.log(page)
            displayRead.innerHTML = ""
            displayRead.innerHTML = `
            
            <h2>${page.title}</h2>`

            if (page.thumbnail) {
                displayRead.innerHTML += `
                <img width="100px" src="${page.thumbnail.source}">
                `
            }
            displayRead.innerHTML += `
            <p>${page.extract}</p>
            
            `

            return page.extract; // Aquí tienes TODO el contenido
        }

        async function wikiSearch(q) {

            if (!q) q = inputSearch.value

            // action = opensearch
            //const url = `https://es.wikipedia.org/w/api.php?origin=*&action=opensearch&search=${encodeURIComponent(q)}&limit=50&format=json`;


            const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(q)}&format=json&origin=*`;

            /*
            
            https://es.wikipedia.org/w/api.php
            ?action=query
            &list=search
            &srsearch=${encodeURIComponent(q)}
            &format=json
            &origin=*
            
            */

            const res = await fetch(url);
            const data = await res.json();
            displaySearch.innerHTML = ""
            data.query.search.forEach(element => {
                displaySearch.innerHTML += `
                
                <h3>${element.title}</h3>
                <p>${element.snippet}</p>
                
                `
            });

            return data.query.search; // Lista de artículos
        }

        async function wikiCategories(category) {

            if (!category) category = inputCategory.value

            // prop = categories
            //  const url = `https://es.wikipedia.org/w/api.php?origin=*&action=query&format=json&prop=categories&titles=${encodeURIComponent(title)}`;

            const url = `https://en.wikipedia.org/w/api.php?action=query&list=allcategories&acprefix=${encodeURIComponent(category)}&format=json&origin=*`;

            /*
            https://en.wikipedia.org/w/api.php
            ?action=query
            &list=allcategories
            &acprefix=${encodeURIComponent(prefix)}
            &format=json
            &origin=*
            */

            const res = await fetch(url);
            const data = await res.json();

            displayCategories.innerHTML = ""
            data.query.allcategories.forEach(element => {


                displayCategories.innerHTML += `
                
                <h3>${element["*"]}</h3>
                
                
                `
            });

            return data.query.allcategories; // lista de categorías
        }

        async function wikiCatArt(cat) {

            if (!cat) cat = inputCatArt.value

            const url = `https://en.wikipedia.org/w/api.php?action=query&list=categorymembers&cmtitle=Category:${encodeURIComponent(cat)}&format=json&origin=*`;

            /*
            
            https://en.wikipedia.org/w/api.php
            ?action=query
            &list=categorymembers
            &cmtitle=Category:${encodeURIComponent(cat)}
            &format=json
            &origin=*
            
            */

            const res = await fetch(url);
            const data = await res.json();
            displayCatArt.innerHTML = ""
            data.query.categorymembers.forEach(element => {


                displayCatArt.innerHTML += `
                
                <h3>${element.title}</h3>
                
                
                `
            });

            return data.query.categorymembers;
        }

        // WIKIMEDIA API

        async function wikimediaImages(category) {

            if (!category) category = inputWikimediaImages.value

            const url = `https://commons.wikimedia.org/w/api.php?origin=*&action=query&format=json&generator=categorymembers&gcmtitle=Category:${encodeURIComponent(category)}&gcmtype=file&gcmlimit=10&prop=imageinfo&iiprop=url`;

            const res = await fetch(url);
            const data = await res.json();
            const pages = data.query.pages;

            const urls = Object.values(pages).map(p => p.imageinfo[0].url);
            
            displayWikimediaImages.innerHTML = ""
            urls.forEach(element => {
                displayWikimediaImages.innerHTML += `
                <img height="100%"" src="${element}">
                `
            });
           
            return urls;
        }

        wikimediaImages('Robots');

    </script>

</body>

</html>